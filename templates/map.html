<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .header {
            background-color: #3b5998;
            color: white;
            padding: 15px;
            text-align: center;
        }
        #map {
            height: 600px;
            width: 100%;
            z-index: 1;
        }
        .filter-panel {
            padding: 15px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: space-between;
        }
        .category-filter {
            margin-right: 20px;
        }
        .time-filter {
            display: flex;
            align-items: center;
        }
        .time-filter input {
            margin: 0 5px;
            width: 80px;
        }
        .event-info {
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            max-width: 250px;
        }
        .event-info h3 {
            margin: 0 0 5px 0;
            color: #3b5998;
        }
        .event-info .date {
            font-style: italic;
            color: #666;
            margin-bottom: 5px;
        }
        .event-info .description {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ title }}</h1>
    </div>

    <div id="map"></div>

    <div class="filter-panel">
        <div class="category-filter">
            <label for="category-select">Фильтр по категории:</label>
            <select id="category-select">
                <option value="">Все категории</option>
                {% for category in categories %}
                <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="time-filter">
            <label for="year-start">Период:</label>
            <input type="number" id="year-start" placeholder="с года">
            <span>—</span>
            <input type="number" id="year-end" placeholder="по год">
            <button id="apply-time-filter">Применить</button>
        </div>
    </div>

    <script>
        // Инициализация карты с центром на территории России
        var map = L.map('map').setView([61.5240, 105.3188], 3);

        // Добавляем слой OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Массив данных исторических событий
        var eventsData = [
            {% for event in events %}
            {
                id: {{ event.id }},
                title: "{{ event.title }}",
                date: "{{ event.date }}",
                description: "{{ event.description }}",
                location: { lat: {{ event.location.lat }}, lng: {{ event.location.lng }} },
                category: "{{ event.category }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Функция для извлечения года из строки даты
        function extractYear(dateStr) {
            // Если дата содержит дефис (формат YYYY-MM-DD), берем первую часть
            if (dateStr.includes('-')) {
                return parseInt(dateStr.split('-')[0]);
            }
            // Иначе пробуем преобразовать всю строку в число
            return parseInt(dateStr);
        }

        // Функция для создания маркеров на карте
        function createMarkers(events) {
            // Очищаем существующие маркеры
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Добавляем новые маркеры
            events.forEach(function(event) {
                var marker = L.marker([event.location.lat, event.location.lng]).addTo(map);

                // Добавляем всплывающую подсказку
                var popupContent = '<div class="event-info">' +
                    '<h3>' + event.title + '</h3>' +
                    '<div class="date">' + event.date + '</div>' +
                    '<div class="category">Категория: ' + event.category + '</div>' +
                    '<div class="description">' + event.description + '</div>' +
                    '</div>';

                marker.bindPopup(popupContent);
            });
        }

        // Функция для фильтрации событий
        function filterEvents() {
            var selectedCategory = document.getElementById('category-select').value;
            var yearStart = document.getElementById('year-start').value ? parseInt(document.getElementById('year-start').value) : null;
            var yearEnd = document.getElementById('year-end').value ? parseInt(document.getElementById('year-end').value) : null;

            var filteredEvents = eventsData.filter(function(event) {
                var eventYear = extractYear(event.date);

                // Фильтр по категории
                var categoryMatch = !selectedCategory || event.category === selectedCategory;

                // Фильтр по временному диапазону
                var yearStartMatch = !yearStart || eventYear >= yearStart;
                var yearEndMatch = !yearEnd || eventYear <= yearEnd;

                return categoryMatch && yearStartMatch && yearEndMatch;
            });

            createMarkers(filteredEvents);
        }

        // Инициализация событий
        document.getElementById('category-select').addEventListener('change', filterEvents);
        document.getElementById('apply-time-filter').addEventListener('click', filterEvents);

        // Создаем начальные маркеры
        createMarkers(eventsData);
    </script>
</body>
</html>